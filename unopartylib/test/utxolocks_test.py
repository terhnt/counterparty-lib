#! /usr/bin/python3
import pytest
import binascii
from io import BytesIO
import bitcoin
import tempfile

from unopartylib.test import conftest  # this is require near the top to do setup of the test suite
from unopartylib.test.util_test import CURR_DIR

from unopartylib.lib import (transaction)
from unopartylib.lib.messages import send


FIXTURE_SQL_FILE = CURR_DIR + '/fixtures/scenarios/parseblock_unittest_fixture.sql'
FIXTURE_DB = tempfile.gettempdir() + '/fixtures.parseblock_unittest_fixture.db'
FIXTURE_OPTIONS = {
    'utxo_locks_max_addresses': 2000
}


def construct_tx(db, source, destination, disable_utxo_locks=False, custom_inputs=None):
    tx_info = send.compose(db, source, destination, 'XUP', 1)
    return transaction.construct(db, tx_info, disable_utxo_locks=disable_utxo_locks, custom_inputs=custom_inputs)


def test_utxolocks(server_db):
    transaction.initialise()  # reset UTXO_LOCKS

    """it shouldn't use the same UTXO"""
    tx1hex = construct_tx(server_db, "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P", "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P")
    tx2hex = construct_tx(server_db, "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P", "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P")

    tx1f = BytesIO(binascii.unhexlify(tx1hex))
    tx1 = bitcoin.core.CTransaction.stream_deserialize(tx1f)

    tx2f = BytesIO(binascii.unhexlify(tx2hex))
    tx2 = bitcoin.core.CTransaction.stream_deserialize(tx2f)

    assert (tx1.vin[0].prevout.hash, tx1.vin[0].prevout.n) != (tx2.vin[0].prevout.hash, tx2.vin[0].prevout.n)


def test_utxolocks_custom_input(server_db):
    transaction.initialise()  # reset UTXO_LOCKS

    """it should use the same UTXO"""
    custom_inputs = [{
        'txid': '2c3416c8742fa71caea929e6cdf10e02fc10dd39d8b5bd36a71498f3173ed0bd',
        'txhex': '010000007798e9ab993fc529ef037cf3728ba51dac5ac196fe4bf6194cd319fe5b92a519dd00000000484730440220798071268b37ba27100d528bf67aefaa93fe6be04840143151d28d1522e4415f022010c92ec7612e44dbea898353468868e5a1a2d7b60b5aa18263ce37cbb138712e01feffffff806ac41eae1491fa86a556a368b721e2e0ad16402e226c7ba61eb33122110c76000000004847304402203cfbbb4a34244bcd0d08ae2cfd804dafbcde767e2c36cb9f6a5865e1a3ce5a6502201aa937ce778c53a03a56f9b68002e6ff9e8f9e0ab9c8c34643f56b40df6333d601feffffff3910a19e120805a9831bb2b72036f922e04ba751f15b694dd49308e18aafabd30000000049483045022100c3ee73a84ddde610293d7df6382836517ea20546b2ca5e92c6df6ab3e95ae5fb022068fa398bd549108bbe931f55af3b12b661d583215bc3ebd7ad05c80654383e1901feffffffe7a8010f588721acd3e065c0278192d272cdc6ff45f1d78c456ee021ef77680e0000000049483045022100e7668e5b2fe2b3510bb2029229dd06eb01fa6d7ecb06b4402350e8767787900a02207b5170a76033a1fafa483fb1e30f320238f502bbf566fdbfeaa8b12977e34e1d01feffffff3920853879c39d753cad77f147b4a528442b751a671208d5bda737876b018b3b0000000049483045022100fa959bf2a1ff7a7bc60faa8b262215f7ec947cf9780d068b2901d52942fbfa94022071e593aa6d47c3c7262cda498b4c2ee1a4f8c29b7d43fa00fb667c206a5642db01feffffffcf011a5a8e5c59ced7205eb5d3b8225b82a708e1057c4420c2040e212820ba850000000049483045022100d654640e844c642e19952610a2ca9423958e1bfd583d17f2988e7e697dbcb8f602203e81d746b14bd4206a60d5447a40e2329bf8a737012a5a015bf9f3c8161ba31b01feffffff97db63374d570a6933a2e7a8ea2825271c55ae4af79850bc27249c4e691bebe9000000004847304402201100af776e2878877b012e12b468a39728b1344161e83dde080e22030906ed130220168f6c5f5b41f335233a5976370082ee16052e2fe68a3c104ce28347c6c151d101feffffff30798c1411d15594266a363cd361bbffe881fd6b40506dfc48e203cdce3452ef0000000049483045022100a946852106c7c4ec6e9db04d10a81e3d0425b1ce2bb165e5253e69bf052019f7022060b05498bdf5a8930b1a5ec9a612ee54f03c9edc769eeb8e2f7dafe55cf3178101feffffff9d7bc10c83b2bca0202ae8a1d7aba2d3cbbfe4514c3a02885c61fb147464b4da000000006b483045022100c7ad0d9e4863a2682647500b12dad7abd8f7f7f2e65fd67b76084633ec8bd25a0220166f0809b0f3a038cd1c9c128e1295dd9a2975f63ceb332b9751044f0cfc3f8e012102a5cc8619394ebe13715b352021c84d2d00f847b6be80d016768c0de4b1dbe677feffffff9d7bc10c83b2bca0202ae8a1d7aba2d3cbbfe4514c3a02885c61fb147464b4da010000006b483045022100e1917231ab9a4e4e046d83197370d0c8eeb5f2303f7847af0cb6b850be33e46402205e295c15d977405b5e40e866183cdd164e5957aa8142d0c7ce32a6f89fdd8c6e012102ce0b4717107f6ef463a47cefb33167a3105e1d47e9dc6c3abfe9c2ebe84a21c1feffffff87d3538b5cc94b4d8e6c9440367b019416f8c8c2d23316a46805fdb78dde2e05000000004847304402202255a5d1c9d583f27096e30254e781d6a41fa417439dfc17569f30065a17047002205a7a240f0d275b819c9eb69dbe8e9256a2f5d1c7abc0cfe3fc197c7abc78655301feffffffc08954ea987c934776b5d167ce979e778e4fbbef0507217abb5ad18e4018bb8f0000000048473044022014730fc66f961b4cefb4a0a77d6d9e5188dc0c3154c107fe494504b5ead7168f02200b93dfca4f5a610f0f8ac5cf4802ed4e3b6f5522ca3078a6fc5ed020ba1f0ba801feffffff12764179950c9f8465627e40f3f0eb038977d76bbc42224f1dfafcedd6b62713000000004948304502210096825929057b25e0bbe25bf3c31595101cc9e326e3482e2d4164d3c5141bdded02204885bc72aec873df594d46c363b596c3c93efc13f0b8f0ca917ccea6975bc82b01feffffffb84b4beb29944df2fb660a474d81829bc8c6ebb862522a8ab1fa5dc2f06dae73000000004847304402200d9115764fe1c93d71d62117ba6904f5c50f965d3174f0b7d30d0b5ca9121442022018bbb8c764b45a3c9494713f67127a1c05ad3ee42978c06c11ad36cd8e97da1f01feffffffcf92e808b9b0cc5307a4f31e87714a4255a8535b4e8ae7e9908cc9a20eb127020000000049483045022100d74cd84b7a6eaf0642f6077a2e2b479a703a1376c834ebf3fae4296f1f6cd49702204cd7b5eacd12f7bfe80d9d231bec61d936c8b75c17decb27646d03f36eb5eafd01feffffff841df797648e2a1302048cc9c439c50d8f4745376280981501a76c773e380ab50000000049483045022100961c352929cec443fd1242d820a795d8ea96fe610bdf6ba74afdaa62cf1d09b602203fbaffb90f03d02004173752c52534737ff9798301ab24240be4f30df6b583bd01feffffffb5b2645f9f8f807f68f1b8f947740c6f6767ae3e398d602415e2e69db9446b34000000004847304402203b42dfc39d8649eebf69bc86ff70c57b67ffc44c74e3be373af359aee859a069022014006d2d2f38caec9989d65127eb6293695f705b4020008436703b0865a4545801feffffff69fec4bfc9660ecce6dc0b54e6189064bd0e51b67bc64fe6953d9ac0d150355f0000000048473044022013952a5b36c985296911fc8d7ffd179b157c36d031acd402b73b1ac98175721a022044325591dae378a214d599846e6dbb68a435ddb2c41be04b4944a845ef03667401feffffffa71ba7c5f50b9fec8bddcf417d067b157c7b157871f4aa2b42e0504ac0bc75530000000048473044022071988222b55b0a2a0b917a88dd2d237f09d97ff1792197c359d1c6850d53d6070220236613f8b43183c3996530ae1b5a857cc5721dff1d8c0b7be8e52c3b9d6c1d8e01feffffff95d64bebce9ad5163aec589c069a9d6cfcab407314cb4cae22c5d4a25bc296fc000000004847304402203a1bac7fbcd3f6441055e2845374689bb6a53e4de63fe52879dcd0a589de53a60220752626f08030d0719f4a67388c30db8311e7c1020f3520d8351b3ae7c3d2ee2201feffffff0c67d6143e63eeb739fbde1cffd3ba404996870f1c66e2b470a0ce929c53343900000000484730440220161e92aafaeb67633ad503334190402ec6bcc01484ff491ce4804a97d2544a680220703cfa22b095cf271c700d6585a544abb56155f2f17bd39e9710516a5468146201feffffffe021350751f658b8907a939a2fd4c03ee1069266ea0eb39c2a1496750d7889b2000000004948304502210093443cd7eae1131affe8f37d2ed52e130de0ecd972536ca6611aa429b96ab2ec022057c7f5d61622c238ce53fee374adaa7159c58a5f3b1b85861e8d2c0fd9cec93e01feffffffed8e43b66feb1203fed6c4560b1cbb11f9c7050474e2ae0d711301a88cd0f4b00000000048473044022002c057d93d8d12dff56e3e63f31cc011ebd4bca8d627705c341b83e747671664022063b908ae5fa291ded58b170b679400ffc5b9f5360a979e335a94af8506fb1ad701feffffffb2ec67080ab4cc0b6fc5045982dbed029c715de31e7388025b04f8c4f0b051fc000000004847304402201cf6cafdc1877e28f593fe6cda221ab1ddfa249c87dc6f19f8001c7920fb321f0220250fc4517d8b6c5066b53cf38479de2cc1f7a65043ed118d76431f301140461301feffffffbed52eed16d1b07d549226a01ddc64450590b63ae93dcdc2e686177506a7d9e20000000048473044022073f36b22453d34c91425c791221add19e6a047b9536369fd377a7d4be6fdf43402206b801fa4534055c948d39b81c32a7e55a16d280535c46c7c6ae51a85ff5dbda801feffffff3177ec65aa2815266c47f5d82cf561055d65d79089049670979eb45d6f01a61d0000000049483045022100c1b5c65b2f16365412a284399db1fe98b7e6161eaeaace860b03b0ccc02c6aae022076525bbaf51551ff1fdce46bfb272d5884258891f96b557257b200d068602e4a01feffffffe33619de67078aa6d7a19150188977ca2186e753b74ac91c254159716b699f100000000049483045022100f9dacda073631000b68a51c3b1d40fc23d55e955269b0dc83cb32afb803d32a502204c31ee06323e9404311b0833ff44d57061b5797be549a438ccaf0c817a01edfc01feffffff92879373f4e8abfc17f51451518bf5eaabd0945bab353d821e219cd8625398920000000049483045022100aa809c42feee203f561dc4702b6702c35fcf18f58510413d122cdace6bf9afe702202f718b4b11de2c7c5870750e0236ce887a85186f241aaeed25303222034ecead01feffffff55b98a91905ee6951047f84a47febe38a4f3c75ccc90d933e05e08714630ceda0000000048473044022064f14fa6c06e1fc72093afcc6f0153e455590b24adace75a649e29e68a42395802200556ba1ece78dc526236900eca6290a332b2c7ab419c113023f1f571316a75a501feffffff9cabfd7e2f71ed2074a1f6654838c008686fa0bf02ac27f0c9e49d27d4a9a1780000000049483045022100922fade6ffd4cc8def98c7be57fb64736751441b329ca382ad71a5d3e7beadae02207a1dbd732a17d8b592e0d6716317bd01637879d1e0aa004a42544abc7a0a48d901feffffffe558bf9ba9c36101d48b71f430fa96b927b74345b91fb78b3d21b3ba1309cb5a00000000494830450221008487fd70be40dc9878968172adce8567e4e4938fe458a523d9a4d55ae572bc06022035049e38e2db28bfb567752fe1dc65c8eef9c20e4c62787b7d79a34da93e2e7601feffffffa8ae44d4da04a37e8de948b83e8ea8eb326957f0153ff740940db5fdfb21741700000000484730440220641a1ca750f8f155b7043bb16451aefc19f3e2e968f5eaf71f0880c29d4bc7ef02204a86fc1e42984ca160e35e8ef335a15b9df6c4bb1721641c3c0bcb2aaf8b88ba01feffffffaee6904568f3b6ff8ec0629819951f9d90aebfe11c006ee6142af5a5dd7ca3f70000000048473044022014af97edde5dfac866446f74797dc5b45b678a47f4cda7b54e33167c676ffd390220100ef92cd07ce5369971c2022ab77d42cb50439fa15171d69b04caa594c8c94501feffffff5e75890530f0500f3eaa2d4c3dc9ddadad86767a69d07cadb491005ecfe8ea5e0000000049483045022100e796f4fa793e2ca75694e34a52593a7dc1ddc53d2c64757e21ab4545c2b65c3c022055f84375dcdb8d5449177bc0d8132d95a0ed55bc2c797a4f9f74d319b1444c2301feffffffca0d905a48095557e478228700f5146db1a4651d981db2b65ac4f6fabfe2d92f0000000048473044022041d7dcd72b6d3996731a9baae00f18111a71efcbca4dd670dbc18cf3966cfc47022020659ba608fa7416b3d450b027d876bb5f97fc66996b9d1d9a6466afe19adb1a01feffffff4e46599d5e53c1a78cb8e99c1c65257754700ca5e3ef9078f14fd4b463d745e800000000494830450221008f441e26b3c78ea7a8e3fcdcee4a92876e711c2df091dca61b8cdecff202d5f60220647b31de5d6f00b98813c43e699296f70d25eab0ab6df61045bec87a7b7e84e801feffffff0fc38b1dfec744e27e104ff75dc13f34f6ce614b8c49e26c9210f910aca76afc0000000048473044022031b7a462e90202f068d9f8a1afbd471eb6c38a62b25c3a5052b778cd6b9797290220242d79aa68a3934ddd5833cf41b01e75f32bcc64a47fa3cea4502f406181c4f401feffffff66e1736b65bcbd9eff9469343970f339e9557e1056aa7232d027c8da7f0609720000000049483045022100b868cd060b99059c065d7ff6048f5b3fcd4eae7571a0aaefd4293ebc1eea8451022032c7e0d67ff2027026bf658574bc0db5c1cc832637dbc9b84af4a05cddaeb79201feffffffdfcfe6cca96d1f7537de60155e9e3402800db953e2d3412db837d44399e7c6470000000049483045022100e58e4eb8ef81b30d08f8d4231494c958732f1b0a8a3f56a66e3f6f34fd37cf7f02204b84145df04e6c904483e85548c16c0105f566457a58ff41c3593a724101299c01feffffffdd7033820319f13c1a914bf792a56a880d98e7422955f6d0646fad462d67f61a00000000484730440220207f8641e523d313257d9a4934d3ffd00e196125ba73a51e7aad8c2fd24428b7022015dbd729e0758ae7e51e34fd8474e62bcc2e0c55a656ab5d0c9ba586f9c2d9db01feffffff1a15744ff2131f3bfba3128dfeca241ebf5f082fcabe9a8b9d7dcc6177be0ef3000000004847304402205b2ab54ad67a8712212e62a57b15037832cdf182cbab016dcc602e4a39e2682e02204d75649dcbb440143b6234455fcc8d25e8185b856a8d2e39826fb0c9428271ce01feffffff71cda893759174e4aa695d3c19d129303b6ca63f7f6ef89019a616edf459ca63000000004847304402207c07c57d91784ed219835ec652267224b2c35dcebd3cd5307fbcd6bd7e975d5a02205ad1ff19ad888d6a774f9feb61674066a1c3f1f0efb43e60e803c711f631adf601feffffff0aaff7b56842b8fa68832ba83919449e52e6911d709e1731ecf8a5d79cf05dba000000004847304402204fe54062e6731e9ac3363f5c3121c9002718f146951dff8ba3fd6e285e339fcb02200b0ff117a007b94c7b1ae77b225bca3b08a5068729dacfa64ba471420260f2e801feffffffaa4f18e008150f71661d00c6a8a23bb40a166beba9df5c04e688257550947b0c000000004847304402205fc9d64a174c229f9fb5a4ea6d408c79cc32981f42e8dffd100c2a6897f4838b02203acfd2e0a1e63da4a6ee7a7d6d6d895637fec126ec80332c8524c96f01a3ade301feffffff6eeba9c3f2d0a3b649d182cd9af8d9441075964acee3e4e678e7d35a44343e57000000004847304402205c5721820fd2987edc7e62b15c7440f7e47c1d6052792e87050785249af8a96702206aa25d46cba24997bc42e5602efe479f51079bfb26e7562890af94a10282801801feffffff385919aa7afc6a03bfdc656e28f15109a3c828e2bff2707d70b86a2ad91f0f3200000000494830450221009e77573747901c72c81aa97270e6fc7451191a207db6428555a0183295730184022045346d698786380ebb86c052b8cba80ac4c37a7342b8fd460e34f6b4d6eef96301feffffff42f96817b627b828dd204e968e89bad4cb012a79c669600a6151d8107b033c450000000049483045022100d73652af75f7ea0ddf339b83365e5021bee3baa41e515a240275b92b1fe5108e022076b1ac8d4168169895f82ffccda248029d340e411ff4e6644737c13b8351061f01feffffff62dbbd9fea1f1cc48a5dbea250550ac2380a2d6dd7d764c842a22d5e441a06410000000049483045022100a9222cff45488618c916c235ee9081e1074fd71b4ade51a2901411de278e0e9902204a1e3db06ee617fb388fd326160c631c87324f59aa98522fc233e7f769332cec01feffffff258077586c8c7ae49a95a286f276ab55048e7690bafed91df33119697ac6cf340000000049483045022100f246b38b65e38b728334c5baeac2ae0a54e5ae4767434dae6b2a139fb6f26fe70220160a822ac27711418cb21e08d6f81d46c00fe78752297f60081d64d839e27a1801feffffff64d372aeb07cd03a436cd1942e6cc9091b646b967a1817fe48c6961f4b98b7560000000049483045022100e3fa94a84e9b972a8f7ab27cb4ff90ca69fe2f4c331cf912b34d34ba8591c1a202204b8d835ac2134d7f89c93220a92fa5b2b8cd776a87589ea81ba3f27ab35a53ea01feffffffaee14a01e71c04f21c543d60ed2611105786a9eb99b18e2a5938ff21a730af21000000004847304402205f39d6deca8f0b04d5c9dbc8999cc09e8eb484689221f657bcdb11d81f35cd5902205a681c2cd6de92586a9bd93118152f48fcc46ecd7f8c44e1a8967fdad01770e101feffffffa71594e3a8f96fe01b5e1d86dfc1d988f1bf8dadd52fa661a7ef19901d8c29470000000048473044022016e959292a1a4c7d764b03b0c90a3e9939195db1ba4a82c92175b55c1e6e55df022034e99f5dbd0a7184f80adda447ef2a5494e4576fcafce673a1fbdbb5d93c7fac01feffffff4c6822a28a72b562c485bb6a42666ea44cacb45b5976ab61b4397e60cabe7b2000000000484730440220754bf38188a0432065d22419c703db00bef1c5fc26535b2c32059d3812ec8169022043629a03fbbb77a24713c5d8342179f1e1593974f552c327b0fa84d92579c36d01feffffffbffc29d4d59e83c4bf9c9e157ebbab7ed63ea244ad7a769626954892e18676b000000000484730440220756504d644d6c2045dcaa507055052af5daf65777aa6d39b91c17b240f8a54ed022059615b14f34572dba50f003b6ddd9b00ac39e84a8dcb9c60159c776356485b5d01fefffffff9cd1e3126d5399713f51223aef06fbbeb8c874bcab2095fbc7c3aee5702d6af000000004847304402201d8fa02a325abf845787836407648633620f1e41e9ad298abf981708f692a8a0022066a099a6200176aa4d880aec997bdefd4fd23333cd94e3a11556f8405f77f06501feffffffb6620c3895ac8fd56d39982f47b85fa42af77871404170f81c303d00c2f7040e0000000049483045022100fa4dc54aaff17f66b4c5f4937c902cfd4f4277f2d16c36513264c4483c8d1713022022dc749e834115f056f40bc069d8f36c34439b4176aedc20320ef2e0f00493e201feffffffcf34b8145724564282480c7e56f203ee4d6bdd88f705c4e0199656702669237c00000000484730440220241eaa45b46ad4c486285ddc6ea744692304a1d3a26e8a5c86adf70c42bf771802202b055c940bfd1c391c7591968ff9661cd2aa02761fced43ef078d4963820c4fc01feffffff405aecf028994be5bafc56e8786e36de46e08a17d9c9bd4a26f84b5b1e8c0a370000000049483045022100e4ebed89d23c54c56201439b77f16871043f91a736f81509fecd79a5d733d3ee022047312505f4e3fbfbf339950ba03a600ab602f0345d8d55aec4a169c26340011801feffffffb06d28767e8f8927107f5e8e66d8a0789038fb1ded799f9656675e174793a2120000000049483045022100df9450cd7d51cbb585da7c4b64fe2facb6f5797ead26204cad66a52c6452570b022022391e5d3e0b0cd37e54b38c5dd91b71bc21adbd5bead62090c101edfc4b3cbf01feffffff84a8fcde86fb5ce055a5f2317ec0e9b6b67b4583d5fcdffc423f67ef99b7f3b7000000004847304402201d8ab9307d01a88c0cc95335d5ea5d4328a9ed786cf86dcc267402714f6399fe02202eb4fe58792c4a8aacf7cdb5694a74e160d4f0ca198f1f8137fec9d415d3762901feffffffee7de77ee6e36b0d00b8777af9a572b15013ef56f40e25b70568b58e3581c4a70000000049483045022100c90695a40f15bf66ccb18040876cc5ae1b2a5f97a7184ffbc64bb66ac5eb1ded02205385cc3bb2851d4ff4b6fcc9862d457e41a97afbf4dd2e1d0992cb2d9e4a019901feffffff42e91151786c3c2538d91694fe77cfe51cba7b6543f5c5e518b1f1bfdab2f1be0000000049483045022100838871894281b2db56f62c430e6bbf67ac33d9ba0a98b9109404cc51b5d0860b02201d95670e0e4b6a1d328ef40733e2e87fff4f1c399d12020989f3d1541df314bd01feffffff9132eadf02e6f2e7dff4903276f6019abaeb1fffd5b726e8337c1a7698f578b800000000484730440220112a91d936557bb521c356ddd52a816c0d8b83d7021d5b253ed92f5d268c1be002205f464dbb7f20837685a7792da10ccfa0a4ec9eeee8126386fda2ca5d3923f8c201feffffff80b82e7c49e104d33935a908d8fcabe51f41e593c335e4581918ddd7da02bfdf0000000048473044022041f48c5cf78b059f06703ce427cc44152f0d4a0c8a850c9f5827459489fb4b8402200f9b72db9e19726eb872da8af1823c5c5341fec4e1fd81fce8294830ae8da7ee01fefffffff299dedeb3dfa3ae8a09d84f466fbe78cd0d4dea53691cf970604721f6f464bc0000000049483045022100f5741ecae731ad8e5041cba78f3481bedabea261bbdb3b484b41ee3a52ea149d022036a93df9cf62fdaef4de58cb720a3e83ec398c55d300362d5e2f929b096a87bd01feffffff14175c68c5f87f2ba73c995f5242b69403ebeed0188a4855acd9d147e01070650000000049483045022100c90d502ec9e4a2169fbf4da6df911d2c484a4b4bff1d750e6096754fdfefacd402202a0fec1f0342a492a98036a09e317fd56387b9547754382aa4d7185c0757961301feffffff27a712d00e11c5e2c2091640b1801f0e3146eef1286820c1dd0ac4141faa12ab000000004847304402205fb1a0e145595ee5a6ff89b9ef206d6526e87707037e41d92c240cf3d52742f3022006b9a37654c0ebfdde48b3386cc8b0e7af9cc2c7daf46030646d812bd49ee6dc01feffffff8ae82e4c3b4d5fa9ea37a63269604061d42adf3a140034fad6437759e36fc10d0000000049483045022100e89c2b2104cb18a545f707b1bb546c35f12e61817715132f5e20293a59ebbf2b02204c43b3a770640e4252b7df209e7b19bef51d0ed3219732d401bf06e1ab78e4d601feffffff7a81785abd7ff816c3f7dc30f8bbec357bc0a04635154146526f2f3f75a22ba100000000494830450221008ea06faf7aea18021af559c1a4a74a1b2c380fdef0e2995b55b5751c180b45d4022078905b9d23f354c1b47b02f7a4cb2a39dbc02133c5c9aa132d9b4826ee65777701feffffff449f202ea9f4a831a80fe70dad6d4d400daa2073e212a66f8b8e6aa56e7f4e04000000004847304402201e7045b70885102940427b6a449168cc97477b1f7feced7164c1821685ee13ad02200713ae3c34d060901e1f65c879dd731d700be75d06da068da9a09c7ec12312d201feffffffb575d5e50a311825a07bac5ea297377f202d071ab38b6ea84e42b13b77b6fbef0000000049483045022100d468f798ab2a5df4ee39e36f1352c5785eef6a6a93c744d5a763efcf6021dbe502201bab83f5631d9846647f85fc4c9bf32d14f11c6810daf9d3a9cb5c8357b982c401feffffff7b334718777dbb87762bacc5246b79ac38a29070354775593e6f485bccbe13dd000000004847304402202f30fadb93e68f8a8c67016419c1d2c7efb477c0151b4a37305fa4b13d71fdba022061f457b918ef1d6da881ca006613012d918a01634c3e03d2e18d4bb7500e73af01feffffff95dad3356525eb738763660ccb6b4604ec6a4faeb7cc487dd96988348d383ee4000000004847304402200568c7b563b5211271e4fb5598df400d795549ca684d5b305b8251b204e3399402207eec1bdd76666e86cd042d72032bcc765078a5aa09410d76ebf7be6ed0d82b4f01feffffff812d5ada2ec27eeb3427dc79c841633a796292b675aa90d6b6a58f39c4fc2d420000000049483045022100bbb2f2548806c73ee794939a58031be8dee2edfd158c3d5d640670c82503cde8022019fb1d57a2619fa72097fb2bffd6bf952524797c0a7408b4ed203ac0d03f88e801feffffff71dc44fd1b120fc54eec52e36b5532e0764562f2e8bec63ac6fc607455f600ee0000000049483045022100905990ebf7929975f6e1c3cc9446586bf6f43fa6d7838d4141a20e0b8490a33c0220416153245707b2a468e8b7b858fa296433e4a487c23f54cc91def1a2b011884601feffffff59fbdb27c8c54d12429c7d3fba6e49c5d0f4a870ca3a341754860f1d7ecc38c00000000048473044022020844e2d050fb0e94ef9344f7b8ae38c000387e6c01a6f44c7e21a0a28fc8afd02204645e4f563b18c146ab4df1f3ccdeab2e41f6988fbf4e71cbb000237b599376401feffffffc817935c9adf79085587e97afa66442ac7303fec5091662834e74f2b0f0b2dfd000000004847304402203504f95462fe6114c1acc541b04c3f289144f43cf822b3855e22662da053507d02204959d54041aedd2a005d591a294eeae4b01f833cde4ccf41563cd267b2ec325f01feffffff33726d184862c607e2ed01c3f82481c3fed83310e3d285f9e23044e79f585edc0000000049483045022100b1bbc504aa05adcc704543c3957c33872e851252c021ef16d3addcd24173639402207ecffde550b07b28c5eacb47523c45b9b5094ef7fbf59cb7491e820d5adff47701feffffffe30e6e9f7f82b0de0554bd471fe8a1a04c31f7a77947c357f946043f50553c03000000004847304402200c9227ff383917a27af467d5300c0152628e4f11b33f352050f613b448e24027022018e44fd952c15ecb69493215567321a4441e0cee10af37340dcf8c412fe9298201feffffff655edd1c7fcf2eee5fe3a784cdf4d71b29ae101d98e7cf551734e40d29d507570000000048473044022036b924dd9d921dfcd9315e8fd1972d9e50d86c8d9c2d6a4226c169d8db990b38022067e20089e1201a927364daeccbfa05074ca9e5cbb2900250ee3aabb82f906a5d01feffffff08c00b6afdb573c6e55f04657ea5dcf79ba1835b81831e02efa0aa32d33282640000000049483045022100a43c1d8398a0908cfb07fbbd1a77d8d2482c297a1ec19e790c79cadb81f8caf60220772658d181f80f15ed50243f3433294d8aacf7b86585865b811ebdf21ff0745d01feffffffaaccfba5e45511f5d455b64f806ea10505ed790cee0ce8c67ad5feb14e16f4d60000000049483045022100894ea769e923922eed07999d1931aedd7a77b72f5970851eb5db99c688bbd7f3022034434f0b119408c3ea728cb3bd58e11fb255ccd5416738c82e4b0808ac45212601feffffff7bd6093ed5e26988e9a3a2e6407219964f44dd7970b7968c31797195c789f0900000000049483045022100c8b9de099bd9524beffc16afecbc0eb8003baa460b903060befb30fbca34086d02206c3ac5fdc2d0703ba77ea08b734a8e5a64b02946be12f81e05e3b9e48d92540401feffffff9cded2c4561de03f4bbb62636ea049a18f3c30f9a51e411004e33e41adfe6fc3000000004847304402203d46cb53de495ca0933eef4148f6e2c0f9451582ad14f73483ba9e2ba7570c7d02207d5d0058e87a93769d0932303f9205cc48056cb8eaca0b0d25355515ecd8027401feffffff0acfc677a6d9f77b5857056017f9daaeee450b7941becce7568d44b1d17ed40700000000484730440220032dd706a34be769df5bb76f03169864ea86b99072bcad331f9d8ba8a80c612302206bb90011a5910221a2b79dfa6d29c2a255404a1dd307f74c2b43e08311902fa801feffffff68b0aedd4253842b7516c8c49be569b5a2634ceff79a38a2ad1bb2f1a70e06d6000000004847304402203bd2b90a05891237492f8f6d1e9b91a09c458503897f193f2d9fec4375068297022023cda6a5943af0740f4e1b83ea39a419f5bd8f3e756a52f30c901a1d7b14a9f601feffffffd468ff69081c55f2d15b6ad885a154ad05421295098f41415641f5bd200d8c4f000000004847304402200a915597935a4da0237a96354ea4efefcc981a4cb9d8284cc4eb86c26e442a29022061acd73c2bf542da022b0d9135546582b91e0a1fa5e7f353f1c0cf51f1e750dd01feffffff9ea03210197b62c450cd725e7e6e162c925599d913dfd8850668d12f55880a30000000004948304502210097d291e87358b99e831c11778febd0b2f71527916a707a680ba588c91ec2bbdf02207e1fbd53c3058b7aab813c90457e0c8dcb8b46454ea913ae07db5977657bf1e101feffffffd16c772d44fff422f28f55dcb81ba6583af717ba71f7cc747c17d4af28cc9127000000004847304402200b9c95746481dd2767fa2ec8b3043e1c72ef7928442364789188d0e009c1108b02204e9f02fb14bd9463801797a0e8352351abd74e4231d4b7e8370f09318936171f01fefffffff66af09f12b0a0b52e5cb36f8d55a7958b4ca66da3e2faeadaaf90aef8c29cd400000000494830450221009ebbc9a43923561070f3913fcbfbdba05163757e1ca0121ea6b1d0f07a7facc802206e80984b3d41cabf94a12f9e95e43316f7b6aa1639c7c23d84395ba569df935a01feffffff9ad9805ac0ea304e7152a9cf3a0bc0723a3eaa43c17cc379b855d65ce765ca58000000004847304402207a8f9a562b56124066a2536e7680c2ba7a4df7385fd8b0dbbcfa864792b3863b02201613f2163258392bd8494f623af022c98e816c09252470930025273fe52441dd01feffffff5da965ab613a42c00437e137fe0d125016af032fcb4e7f3241f66983bff409080000000048473044022026250e31d427f323a8b5c595f00fd71c46090b8d2166633252b54c40d43cef6a022004287de864f79cab1e15b826209889349865859fb131bfe97fb7481e21856fe101feffffffc52746b5166fa3f4ebaf785befd618b084859e8186f7cd6db42fec03fa872435000000004847304402204dad7f6ceab776d84d99422dec78e0b914fdb2971d39b1f64efa708976139c1e022043d7b2944ebb4d283815f7f87b1204a7e4e5622a0a568309bc040fc465cecfa101feffffff5aea286e4041bee29d6a884654a0f63c9d972a22e999d4a537bc287842d1ce720000000048473044022019705311d582a7255461da67a2687b89e241ebf7c9a93e06c1af9e071242d923022046cce321507df01c1732c830b3bdba100ac9b5d3d25281ede05482a6e3fb1f7501feffffff0df5d0a5051d046d4519c94f95bd91d69699341dd303bd02894d1cd7b74076ea0000000049483045022100fe79c25c7b16fef06b41d1bad1289718172ef9cb898058509dc202ada0d0259502201f27854eb0c997f7c705b910da8139b5ac9de1ce0130a552416070be80c8770301feffffff567e0cb9d71baae8a09a793e90045bf1a0ba1279488cf119a8869f401038dbf7000000004847304402200d574888749bdd8b887fd8491ddbfba9dc040bf25155032715420da4e2127b7e02201e99935b3fbf7c1e9504cf1280767d9616b69853b5c873073e7d76af3c417eb601fefffffff1b515c224e63a48dce2adbcfa80871fbf01760172e3e09505bc57608179bc07000000004847304402200ee73d9e7a1b0e23a51fc2e685b339ec72c2fa41e72c71915092e0452bb1561502205d13b873d3bb2e14e1919463d287796685a217ff4c7e275ab5f041d28fdbdbf201feffffff1ac6e90fc7f604e432197a50b0163ab68edf62f84846c14bca078dad8273307c0000000049483045022100ed60d64ea07f4efc7710b6699a1056bdd0e0451cc6da30f0fcdd3b88d86c32270220661aef3094da899ed45a38901578acdcd2def80c8a3db598fefd1a04880ce08801feffffff2e96a46ef2bd690066617da9a8783e9830067155a9baec28f144c026775dc1f100000000494830450221009d3b45a746886a5d9a91ca6a050917dde32093bcaa423743f2ba51f4adad1b7602202769b786e545b7eb10bed620d154cf0b47aec48ca57834ea7219ba1606574f4f01feffffff695b2f43d88fd6b056632f965e88668d8fc3394df33ede58fd89e72236409ddd0000000049483045022100ffe93026d7fe196a75102df699fa035e348020fc8390edfe5491cacb1c841c4b0220533882006e4de97b124081361c193d44d8e9ce1f3903cb824f2858c3d40b28df01feffffffb04e107390563f085f6809505309bf45b4ef074cbd5aef0230c5a295841ef573000000004847304402200bdd5e660d8c50e6d49cd4089df69c88cde04b0cc2ac5867ec1af0c264bd6441022075eab928ded8316e7af225861d5060a98defc39afc83e6b594c057715be2ac6801feffffffa736cf2458d167237f2b41edae982da0b1e70106c267302133c5bc4c15aea8400000000048473044022058e75cb39fe6c65bc72b967d2d9fe78eede884bcd18d7f70599a5270d467a8b802207b2c2156e8786c303aab952a644b400079c05df754b30a47df66ab70fdbc39cb01feffffff717b6b377f90b170b72eb65fefb7f251f895f1b2e6e1d7e839cabd5f553677500000000049483045022100ed1e6bcf10b2b7261886c010ae4d4ae1142b18538384b290647b261fec7d5c2402207a39b362409c1494aefa691ae7cfc61bb31827e38504e3c679122e29eab6604001feffffff97b7863aed045333d3a4ae6118ea7329a99cee17f4be571e7f6385e6f1640a5f0000000049483045022100c1690caaed7b720395ea226799899faab77783b38966d0470fa891683b649f5c0220555ac95ebe47e58486ca5a0a5cda6f7b6319607c8ea52235586901adb51b0c3b01feffffff79dff964a7a39bfdb7cfb647086b36ec062569cf372e093d3456ba0188a396f3000000004847304402205525d3338edd71a279bd00c4f90d681df8bf8f5bf48a7fde14d8dadbb4c130ed0220208f646761bc48e9c7f30ec840e08df889738c590acbb91221af74b0d8d1127801feffffffa2470935e629f8c904995b78251a795413a88b6c01180faf361780bd949a03de000000004847304402202b507f3b534de778644386a85578ccef6ffac544cce9fe7e48ddd191e2af2f7a0220653f9ec3191c0c365707e23a4b4929c36a7a66a2342031d7c7a9a220357083bb01feffffffce965dc82394af3a79f2085c2f4b23f32a3e640dd7cba3cb52b3928dfa93da200000000048473044022002009be49cd2aee287ce5f1e8e55c038860f347f5ae9f137b5e820bbafe1c6d802205c5801f6e5495631bbe1a94c30bac3b02035effa570a09d3fe64bef9fe8b295d01feffffff8cacf61f8e579bec02a0dce4c64fe339035030204166913cf09e087a7e5764d0000000004847304402205884129ad78f33db6197d60e7e62be1ebac99d5d11117a0a9c07edb78c34a74f02205643b9d374ae5e8dd8f3439633b1bc340a3a2749816cb4f563ab88b7dd63f10e01feffffff9edd90adf1e3ee5241869b069cd7c1a6a717520af679802ab57b391632aa8d5a0000000049483045022100dde670949c7bdd7b5c39d510aacdbac372b475be5c72ff2b9ba0871b0d671ab702206ad548e170295d1829444cf7a15772a39daba449af86349e3a83f7ac97bb560b01fefffffff6afd548061b8d9ff905f0b605b87290b38beb7e27c0399f7a58412d48377cfc000000004847304402206b93673e15c11425512235c472ded2566221d0e8106e584c630b08b17d25457a02205b697f119358540141865f24bef32bdc51f06c89a920f8f253c1e61562b79b1901feffffff3b6a1440e9beee892a96ab5046cfd2889a4036a22d5874c1367783d77c0553760000000049483045022100e8ce77a95dacaaf5d30352e10061caa96c85a41c020dd4d4371f574047dc72d202203298f462255f8bf32cb3a40e5a3e08d5af7a50c9f9c3fa50ea87ce00e201848a01feffffff6a4630ad76119baac2a7c82d9c5115c4f58fc9c9b395867ae3145f84d00489a60000000049483045022100ffff8768c147e9b230db03247f30fbc908d58f3fe2d60633ca5afaa48c6a4d1f022077bc02f319ddd9ffc4fd9479121d802eb52062bfda6db28f6167cc4b57cffc1801feffffff2fad9d64925443b77ea62dfde38321a0f905fde3ba775c1e8439a15493073f15000000004847304402205eca57caba7e82d10ac9826309301306c1727e7876bfc6e5d0dbad36ad415f8a022026b7acd46c0ce72abd8862313803851e0bf210b081c4386ebc0b52067314694801feffffffea7ee2cba93405a8c9328689294955494f3bfffa709c65f88f79372f528a48100000000049483045022100e5ef084960ceaea6533c1a56fa5aeb066b8c3ca2340fedd5bc4d4dca42fc094802202dc12461e5eb20d898122a00fadfb09ec36af77eaa3c8351d75f80d345fe309401feffffffa7d438d16cf40eb3803c495811d1b6e26fa257c960ba7ba0ba7a5e5b71261a8d00000000484730440220606197a178b2a7298a5dc7fca74959b13d4722d914fb5bb20d80291350de068a022067049fd5e86e2c1bbb789fd183d71749eba4754cbdbb850c1dec0fa15497389b01feffffff28137f475825f4244c7225cc59150bd50205dfb11487724e800608ec119910d500000000494830450221009c065ba511e5f340f533ebe759a3d04210bd142c2fc3f4f55a47eeb9434f8f4702206119de29c1b4bba70652f2dd218da44a7fceeee50b969d6a1d72e18562b2a19001feffffffeee3118b8c0c15fa65c77fa940df6ef587cb17a703d0f90d81f07ac741a69c900000000049483045022100e94cf3dea5d2e609f6c611c6658c19edb48ecd5ab93b6373915d9a8490faba420220375bd6fcf5d2b88cdd078a49ca7370a5af0b86e854d16a4b66dc9addfa730e1b01feffffff46cbd2e9e175171d636a0a223b8097c06b6665b3eb225ce5a1185c2c6c324281000000004847304402202ef4acc0d25cdfbc371a9b8801e5134ee7cbf7833ecabee7832d952a13c89f3902207b61a25c06818bac92e05b13341853d1903a29ed9cf9040a1e40bd991bd1a1dc01feffffff584961feb9095cb44090b17e547b544ee2c45c1fb01f5550fec7af801aa6d1790000000049483045022100edf1e6d11d1bd3a0bbaf73f71dc570372cd214cdbc84ea6eef1c96578ec7fb4d02203a9ceaa5189ec8849642621d5aec48363db20ead0a611cf94ce22400b47095ee01feffffff02a04a7c02000000001976a91478a7602aa3bd71b1a5e777d15a1f8718d50d658388ac8c850f00000000001976a91433e9e62985787e31b7ea0e50050f36b3c676e13c88ac01060000',
        'amount': 0.41700000,
        'vout': 0,
        'confirmations': 11,
        'scriptPubKey': '76a91478a7602aa3bd71b1a5e777d15a1f8718d50d658388ac',
        'address': 'UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P'
    }]

    tx1hex = construct_tx(server_db, "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P", "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P", custom_inputs=custom_inputs)
    tx2hex = construct_tx(server_db, "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P", "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P", custom_inputs=custom_inputs)

    tx1f = BytesIO(binascii.unhexlify(tx1hex))
    tx1 = bitcoin.core.CTransaction.stream_deserialize(tx1f)

    tx2f = BytesIO(binascii.unhexlify(tx2hex))
    tx2 = bitcoin.core.CTransaction.stream_deserialize(tx2f)

    assert (tx1.vin[0].prevout.hash, tx1.vin[0].prevout.n) == (tx2.vin[0].prevout.hash, tx2.vin[0].prevout.n)


def test_disable_utxolocks(server_db):
    transaction.initialise()  # reset UTXO_LOCKS

    """with `disable_utxo_locks=True` it should use the same UTXO"""
    tx1hex = construct_tx(server_db, "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P", "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P", disable_utxo_locks=True)
    tx2hex = construct_tx(server_db, "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P", "UYyyYsKsdw48H5edicJvFatDQS8N8oRH5P", disable_utxo_locks=True)

    tx1f = BytesIO(binascii.unhexlify(tx1hex))
    tx1 = bitcoin.core.CTransaction.stream_deserialize(tx1f)

    tx2f = BytesIO(binascii.unhexlify(tx2hex))
    tx2 = bitcoin.core.CTransaction.stream_deserialize(tx2f)

    assert (tx1.vin[0].prevout.hash, tx1.vin[0].prevout.n) == (tx2.vin[0].prevout.hash, tx2.vin[0].prevout.n)
